{{- if .Values.rbac.create }}
---
# ClusterRole: full access to BootDependency resources + events
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "bootchain-operator.fullname" . }}-manager
  labels:
    {{- include "bootchain-operator.labels" . | nindent 4 }}
rules:
- apiGroups: [""]
  resources: [events]
  verbs: [create, patch]
- apiGroups: [core.bootchain-operator.ruicoelho.dev]
  resources: [bootdependencies]
  verbs: [create, delete, get, list, patch, update, watch]
- apiGroups: [core.bootchain-operator.ruicoelho.dev]
  resources: [bootdependencies/finalizers]
  verbs: [update]
- apiGroups: [core.bootchain-operator.ruicoelho.dev]
  resources: [bootdependencies/status]
  verbs: [get, patch, update]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "bootchain-operator.fullname" . }}-manager
  labels:
    {{- include "bootchain-operator.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "bootchain-operator.fullname" . }}-manager
subjects:
- kind: ServiceAccount
  name: {{ include "bootchain-operator.serviceAccountName" . }}
  namespace: {{ include "bootchain-operator.namespace" . }}
---
# Role: leader election (namespace-scoped)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "bootchain-operator.fullname" . }}-leader-election
  namespace: {{ include "bootchain-operator.namespace" . }}
  labels:
    {{- include "bootchain-operator.labels" . | nindent 4 }}
rules:
- apiGroups: [""]
  resources: [configmaps]
  verbs: [get, list, watch, create, update, patch, delete]
- apiGroups: [coordination.k8s.io]
  resources: [leases]
  verbs: [get, list, watch, create, update, patch, delete]
- apiGroups: [""]
  resources: [events]
  verbs: [create, patch]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "bootchain-operator.fullname" . }}-leader-election
  namespace: {{ include "bootchain-operator.namespace" . }}
  labels:
    {{- include "bootchain-operator.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "bootchain-operator.fullname" . }}-leader-election
subjects:
- kind: ServiceAccount
  name: {{ include "bootchain-operator.serviceAccountName" . }}
  namespace: {{ include "bootchain-operator.namespace" . }}
---
# ClusterRole: metrics authentication
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "bootchain-operator.fullname" . }}-metrics-auth
  labels:
    {{- include "bootchain-operator.labels" . | nindent 4 }}
rules:
- apiGroups: [authentication.k8s.io]
  resources: [tokenreviews]
  verbs: [create]
- apiGroups: [authorization.k8s.io]
  resources: [subjectaccessreviews]
  verbs: [create]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "bootchain-operator.fullname" . }}-metrics-auth
  labels:
    {{- include "bootchain-operator.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "bootchain-operator.fullname" . }}-metrics-auth
subjects:
- kind: ServiceAccount
  name: {{ include "bootchain-operator.serviceAccountName" . }}
  namespace: {{ include "bootchain-operator.namespace" . }}
---
# ClusterRole: metrics reader (for Prometheus scraping)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "bootchain-operator.fullname" . }}-metrics-reader
  labels:
    {{- include "bootchain-operator.labels" . | nindent 4 }}
rules:
- nonResourceURLs: [/metrics]
  verbs: [get]
{{- end }}
